<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>聊天室測試版</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

    <style type="text/css">
        .chat {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .chat li {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #B3A9A9;
        }

        .chat li.left .chat-body {
            margin-left: 60px;
        }

        .chat li.right .chat-body {
            margin-right: 60px;
        }


        .chat li .chat-body p {
            margin: 0;
            color: #777777;
        }

        .panel .slidedown .glyphicon, .chat .glyphicon {
            margin-right: 5px;
        }

        .panel-body {
            overflow-y: scroll;
            height: 500px;
        }

        ::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
            background-color: #F5F5F5;
        }

        ::-webkit-scrollbar {
            width: 12px;
            background-color: #F5F5F5;
        }

        ::-webkit-scrollbar-thumb {
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, .3);
            background-color: #555;
        }

    </style>

</head>

<body>

<div class="container">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                        aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">聊天室測試版</a>
            </div>
        </div>
    </nav>

    <div class="row">
        <div class="col-md-7">
            <h2>聊天室狀態: <span id="status"></span></h2>
            <h2>線上人數: <span id="count"></span></h2>
            <h4>房間id: <span id="room_id"></span></h4>
            <div class="input-group">
                <input id="btn-room-id" type="text" class="form-control input-sm"
                       placeholder="新的房間id"/>
                <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="btn-chat" onclick="room()">
                                切換房間</button>
                        </span>
            </div>
            <div class="panel panel-primary">
                <div class="panel-collapse" id="collapseOne">
                    <div class="panel-body">
                        <ul class="chat" id="chat">

                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input id="btn-input" type="text" class="form-control input-sm"
                                   placeholder="Type your message here..."/>
                            <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="btn-chat" onclick="send()">
                                Send</button>
                        </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="panel-footer">
                <div class="input-group">
                    <input id="rid" type="text" class="form-control input-sm"
                           placeholder="房間id"/>
                    <input id="token" type="text" class="form-control input-sm"
                           placeholder="認證token"/>
                    <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="btn-chat" onclick="login()">
                                進入聊天室</button>
                        </span>
                </div>
            </div>
            <div class="panel-footer">
                <div class="input-group">
                    <input type="radio" name="red_type" value="random">拼手氣<br>
                    <input type="radio" name="red_type" value="equally" checked>普通<br>
                    <input id="red_amount" type="number" class="form-control input-sm"
                           placeholder="紅包金額，最低1元，單包 or 總金額 看選擇的種類"/>
                    <input id="red_count" type="number" class="form-control input-sm"
                           placeholder="紅包數量"/>
                    <input id="red_message" type="text" class="form-control input-sm"
                           placeholder="紅包訊息"/>
                    <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="btn-chat" onclick="sendRed()">
                                發紅包</button>
                        </span>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="uid" name="uid" value="">
    <input type="hidden" id="key" name="key" value="">

    <!-- Modal -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">搶到紅包</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="modal-name">xxx的紅包</p>
                    <p id="modal-text">紅包訊息</p>
                    <p id="modal-money">獲得多少錢</p>
                </div>
                <div class="modal-footer">
                    <button type="button" id="modal-id" class="btn btn-primary" data-id="">查取领取详细</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModaTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="red-select" class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script>
    const rawHeaderLen = 10;
    const packetOffset = 0;
    const headerOffset = 4;
    const opOffset = 6;
    // const host = "192.168.0.138"
    const host = "127.0.0.1"

    var ws
    var textDecoder = new TextDecoder();
    var textEncoder = new TextEncoder();
    var Client = function (options) {
        var MAX_CONNECT_TIMES = 10;
        var DELAY = 15000;
        this.options = options || {};
        this.createConnect(MAX_CONNECT_TIMES, DELAY);
    }

    var appendMsg = function (text, op) {
        obj = JSON.parse(text);
        console.log(op)
        if (op == 6) {
            if (obj.type == "message") {
                document.getElementById("chat").innerHTML += "<li class=\"left clearfix\"><span class=\"chat-img pull-left\">\n" +
                    "                            <img src=\"http://placehold.it/50/55C1E7/fff&text=U\" alt=\"User Avatar\" class=\"img-circle\"/>\n" +
                    "                        </span>\n" +
                    "                                <div class=\"chat-body clearfix\">\n" +
                    "                                    <div class=\"header\">\n" + "                                    <small class=\" text-muted\"><span class=\"\"></span></small>\n" +
                    "                                        <strong class=\"primary-font\">" + obj.name + "</strong>\n" +
                    "                                    </div>\n" +
                    "                                    <p>\n" +
                    obj.message +
                    "                                    </p>\n" +
                    "                                </div>\n" +
                    "                            </li>";
            }

            if (obj.type == "red_envelope") {
                document.getElementById("chat").innerHTML += "<li class=\"left clearfix\ red-message \" data-token=\"" +
                    obj.token +
                    "\"><span class=\"chat-img pull-left\">\n" +
                    "                            <img src=\"./redenvelope.png\" alt=\"User Avatar\" class=\"img-circle\"/>\n" +
                    "                        </span>\n" +
                    "                                <div class=\"chat-body clearfix\">\n" +
                    "                                    <div class=\"header\">\n" + "                                    <small class=\" text-muted\"><span class=\"\"></span></small>\n" +
                    "                                        <strong class=\"primary-font\">" + obj.name + "</strong>\n" +
                    "                                    </div>\n" +
                    "                                    <p>\n" +
                    obj.message +
                    "                                    </p>\n" +
                    "                                </div>\n" +

                    "                            </li>";
            }

            if (obj.type == "top") {
                document.getElementById("chat").innerHTML += "<li class=\"left clearfix\"><span class=\"chat-img pull-left\">\n" +
                    "                            <img src=\"http://placehold.it/50/55C1E7/fff&text=U\" alt=\"User Avatar\" class=\"img-circle\"/>\n" +
                    "                        </span>\n" +
                    "                                <div class=\"chat-body clearfix\">\n" +
                    "                                    <div class=\"header\">\n" + "                                    <small class=\" text-muted\"><span class=\"\"></span></small>\n" +
                    "                                        <strong class=\"primary-font\">" + obj.name + "</strong>\n" +
                    "                                    </div>\n" +
                    "                                    <p>\n 置頂:" +
                    obj.message +
                    "                                    </p>\n" +
                    "                                </div>\n" +
                    "                            </li>";
            }
        }
    }

    function login() {
        var heartbeatInterval;
        ws = new WebSocket('ws://' + host + ':3102/sub');
        ws.binaryType = 'arraybuffer';
        ws.onopen = function () {
            auth();
        }

        ws.onmessage = function (evt) {
            var data = evt.data;
            var dataView = new DataView(data, 0);
            var packetLen = dataView.getInt32(packetOffset);
            var headerLen = dataView.getInt16(headerOffset);
            var op = dataView.getInt32(opOffset);
            console.log("receiveHeader: packetLen=" + packetLen, "headerLen=" + headerLen, "op=" + op);

            switch (op) {
                case 2:
                    var json = textDecoder.decode(data.slice(headerLen, packetLen));
                    var msgBody = JSON.parse(json)

                    document.getElementById("uid").value = msgBody.uid
                    document.getElementById("key").value = msgBody.key

                    document.getElementById("status").innerHTML = "<color style='color:green'>ok<color>";
                    document.getElementById("room_id").innerHTML = msgBody.room_id;
                    console.log(msgBody)
                    console.log("receive: auth reply");

                    heartbeat();
                    heartbeatInterval = setInterval(heartbeat, 30 * 1000);
                    break;
                case 4:
                    document.getElementById("count").innerHTML = "<color style='color:green'>" + dataView.getInt32(headerLen) + "<color>"
                    console.log("receive: heartbeat");
                    break;
                case 5:
                    for (var offset = rawHeaderLen; offset < data.byteLength; offset += packetLen) {
                        var packetLen = dataView.getInt32(offset);
                        var headerLen = dataView.getInt16(offset + headerOffset);
                        var op = dataView.getInt32(offset + opOffset);

                        var msgBody = textDecoder.decode(data.slice(offset + headerLen, offset + packetLen));
                        messageReceived(msgBody);
                        appendMsg(msgBody, op);
                    }
                    break;
                case 6:
                    var json = textDecoder.decode(data.slice(headerLen, packetLen));
                    appendMsg(json, op);
                    break;
                case 8:
                    var json = textDecoder.decode(data.slice(headerLen, packetLen));
                    var msgBody = JSON.parse(json)
                    document.getElementById("room_id").innerHTML = msgBody.room_id;
                    console.log(msgBody)
                    break;
                case 9:
                    var json = textDecoder.decode(data.slice(headerLen, packetLen));
                    var msgBody = JSON.parse(json)
                    console.log(msgBody)
                    break;
                case 20:
                    var json = textDecoder.decode(data.slice(headerLen, packetLen));
                    var msgBody = JSON.parse(json)
                    console.log(msgBody)
                    break;
                default:
                    break
            }
        }

        ws.onclose = function () {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            setTimeout(reConnect, delay);

            document.getElementById("status").innerHTML = "<color style='color:red'>failed<color>";
        }

        function heartbeat() {
            var headerBuf = new ArrayBuffer(rawHeaderLen);
            var headerView = new DataView(headerBuf, 0);
            headerView.setInt32(packetOffset, rawHeaderLen);
            headerView.setInt16(headerOffset, rawHeaderLen);
            headerView.setInt32(opOffset, 3);
            ws.send(headerBuf);
            console.log("send: heartbeat");
        }

        function auth() {
            var token = '{"token":"' + document.getElementById("token").value + '", "room_id":' + document.getElementById("rid").value + '}'
            var headerBuf = new ArrayBuffer(rawHeaderLen);
            var headerView = new DataView(headerBuf, 0);
            var bodyBuf = textEncoder.encode(token);
            headerView.setInt32(packetOffset, rawHeaderLen + bodyBuf.byteLength);
            headerView.setInt16(headerOffset, rawHeaderLen);
            headerView.setInt32(opOffset, 1);
            ws.send(mergeArrayBuffer(headerBuf, bodyBuf));
        }

        function messageReceived(body) {
            console.log("messageReceived:", "body=" + body);
        }
    }

    function send() {
        $.ajax({
            type: "post",
            url: 'http://' + host + ':3111' + '/push/room',
            async: false,
            data: JSON.stringify({
                room_id: parseInt(document.getElementById("rid").value, 10),
                message: document.getElementById("btn-input").value
            }),
            headers: {
                "Authorization": "Bearer " + document.getElementById("token").value,
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
            },
            error: function (data) {
                alert(data.message)
            }
        });
    }

    function sendRed() {
        var amount = new Number(document.getElementById("red_amount").value);
        var count = new Number(document.getElementById("red_count").value)

        $.ajax({
            type: "post",
            url: 'http://' + host + ':3111' + '/red-envelope',
            async: false,
            data: JSON.stringify({
                room_id: parseInt(document.getElementById("rid").value, 10),
                amount: amount,
                count: count,
                message: document.getElementById("red_message").value,
                type: $("input[name=red_type]:checked").val()
            }),
            headers: {
                "Authorization": "Bearer " + document.getElementById("token").value,
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
            },
            error: function (data) {
                alert(data.message)
            }
        });
    }

    function room() {
        var headerBuf = new ArrayBuffer(rawHeaderLen);
        var headerView = new DataView(headerBuf, 0);
        var room = '{"room_id":' + document.getElementById("btn-room-id").value + '}'
        var bodyBuf = textEncoder.encode(room);
        headerView.setInt32(packetOffset, rawHeaderLen + bodyBuf.byteLength);
        headerView.setInt16(headerOffset, rawHeaderLen);
        headerView.setInt32(opOffset, 7);
        ws.send(mergeArrayBuffer(headerBuf, bodyBuf));
    }

    function mergeArrayBuffer(ab1, ab2) {
        var u81 = new Uint8Array(ab1),
            u82 = new Uint8Array(ab2),
            res = new Uint8Array(ab1.byteLength + ab2.byteLength);
        res.set(u81, 0);
        res.set(u82, ab1.byteLength);
        return res.buffer;
    }

    $(document).on('click', '.red-message', function () {
        $.ajax({
            type: "put",
            url: 'http://' + host + ':3111' + '/red-envelope',
            async: false,
            data: JSON.stringify({
                token: $(this).data("token")
            }),
            headers: {
                "Authorization": "Bearer " + document.getElementById("token").value,
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                $('#exampleModalLongTitle').text(data.status_message)
                $('#modal-name').text(data.name + "的紅包")
                $('#modal-text').text(data.message)
                $('#modal-money').text("獲得 $" + data.amount)
                $('#modal-id').data("id", data.id)
                $('#exampleModalCenter').modal('show');
            },
            error: function (data) {
                alert(data.message)
            }
        });
    });

    $(document).on('click', '#modal-id', function () {
        $.ajax({
            type: "get",
            url: 'http://' + host + ':3111' + '/red-envelope/' + $(this).data("id"),
            async: false,
            headers: {
                "Authorization": "Bearer " + document.getElementById("token").value,
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                $('#exampleModaTitle').text(data.name + "的紅包")
                document.getElementById("red-select").innerHTML =
                    "                    <p>" + data.message + "</p>\n" +
                    "                    <p>獲得 $" + data.amount + "</p>\n" +
                    "                    <p>已領取" + data.take_count + "/" + data.count + "個紅包, " + data.take_amount + "/" + data.total_amount + "額度</p> <br>"
                var mes = ""
                for (var k in data.members) {
                    mes += "<div>\n" +
                        "    <p>" + data.members[k].name + "</p>\n" +
                        "        <p>" + data.members[k].take_at + "</p>\n" +
                        "        <p>" + data.members[k].amount + " 額度</p>\n" +
                        "        </div>\n" +
                        "        <br>"
                }
                document.getElementById("red-select").innerHTML = mes
                $('#exampleModalLong').modal('show');
            },
            error: function (data) {
                alert(data.message)
            }
        });
    });
</script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</body>
</html>
